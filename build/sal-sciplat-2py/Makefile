# We need four pieces of information to build the container:
#  tag is the tag on the input DM Stack container.  It is mandatory.
#  image is the Docker repository image we're pushing to; we can use the
#   default if we don't specify it, which goes to GitHub Container Registry.
#   image may be a comma-separated list of target repositories.
#  input is the base JupyterLab container we use: a JupyterLab implementation
#   engineered to be started by the RSP Nublado machinery.  Other than
#   perhaps changing the input container's tag, it should generally be left
#   alone.
#  supplementary is an additional tag, which forces the build to an "exp_"
#   (that is, experimental) tag and adds "_" plus the supplement at the end.

# Therefore: the typical use of the Makefile would look like:
#   make tag=w_2024_50

# To push to a different repository:
#   make tag=w_2024_50 image=docker.io/lsst-sqre/sal-sciplat

# To tag as experimental "foo" (-> exp_w_2023_50_foo):
#   make tag=w_2024_50 supplementary=foo

# To start from a different input container:
#   make tag=w_2024_50 \
#     input=ghcr.io/lsst-sqre/nublado-jupyterlab-base:hotfix/some-tag

# There are three targets: image, push, and retag.

# The default is "push", and the first two are always done in strict linear
#  order.
# "image" builds the image with Docker but does not push it to a repository.
# "push" (aka "all") also pushes the built image.  It assumes that the
#  building user already has appropriate push credentials set.

# The third target, "retag", is a little different.  Its tag is the tag on
#  the input image, but "input" will, itself, be a sal-sciplat container.
#  "supplementary" will be the tag to add to this image; no substitution will
#  be done on either the input tag or the supplementary tag.  As with "push"
#  it assumes that the building user has appropriate push credentials set.
# There is no point in retagging without pushing, so "push" is always implicit
#  in retag.

ifeq ($(tag),)
    $(error tag must be set)
endif

# By default, we will push to Docker Hub.

ifeq ($(image),)
    image = ts-dockerhub.lsst.org/sal-sciplat-lab
endif

# Our default input image is ghcr.io/lsst-sqre/sciplat-lab:<tag>
#
# Right now the tag has to be manually specified, but a little work on the
# nublado side should at least get us to tag latest on tagged uploads from
# main.
#
# You can always specify it directly, but this should be a sane default for
# kicking off scheduled builds.

ifeq ($(input),)
    input = ts-dockerhub.lsst.org/sal-sciplat-lab:$(tag)
endif

# Extract cycle and build from T&S env file
cycle := ${CYCLE}
build := ${rev}

# Some day we might use a different build tool.  If you have a new enough
#  docker, you probably want to set DOCKER_BUILDKIT in your environment.
#  ... except that as of August 6, 2023, the new builder (which you get with
#  DOCKER_BUILDKIT=1, or by default as of that date) just hangs at the
#  image-writing stage on GitHub Actions.  So we're going to work around it,
#  at least until legacy build support is removed.
DOCKER := docker

# Force to simply-expanded variables, for when we add the supplementary tag.
tag := $(tag)
image := $(image)

version := $(tag)
version := $(version:v%=r%)

# Add cycle and build tags for T&S
ifneq ($(cycle),)
    version := $(version)_$(cycle)
    ifneq ($(build),)
        version := $(version)$(build)
    endif
endif

# Experimentals do not get tagged as latest anything.  Dailies, weeklies, and
#  releases get tagged as latest_<category>.  The "latest" tag for the lab
#  container should always point to the latest weekly or release, but not a
#  daily, since we make no guarantees that the daily is fit for purpose.

tag_type = $(shell echo $(version) | cut -c 1)
ifeq ($(tag_type),w)
    ltype := latest_weekly
    latest := latest
else ifeq ($(tag_type),r)
    # if it's got an "rc" in the name, it's a release candidate, and we don't
    #  want to tag it as latest anything either.
    ifeq ($(findstring rc, $(version)),)
       ltype := latest_release
       latest := latest
    endif
else ifeq ($(tag_type),d)
    ltype := latest_daily
endif

# There are no targets in the classic sense, and there is a strict linear
#  dependency from building the dockerfile to the image to pushing it.

# Retagging is a separate action.

# "all" and "build" are just aliases for "push" and "image" respectively.

.PHONY: all push build image retag

all: push

# push assumes that the building user already has docker credentials
#  to push to whatever the target repository or repositories (specified in
#  $(image), possibly as a comma-separated list of targets) may be.
push: image
	img=$$(echo $(image) | cut -d ',' -f 1) && \
	more=$$(echo $(image) | cut -d ',' -f 2- | tr ',' ' ') && \
	$(DOCKER) push $${img}:$(version) && \
	for m in $${more}; do \
	    $(DOCKER) tag $${img}:$(version) $${m}:$(version) ; \
	    $(DOCKER) push $${m}:$(version) ; \
	done && \
	if [ -n "$(ltype)" ]; then \
	    $(DOCKER) tag $${img}:$(version) $${img}:$(ltype) ; \
	    $(DOCKER) push $${img}:$(ltype) ; \
	    for m in $${more}; do \
	        $(DOCKER) tag $${img}:$(ltype) $${m}:$(ltype) ; \
	        $(DOCKER) push $${m}:$(ltype) ; \
	    done ; \
	fi && \
	if [ -n "$(latest)" ]; then \
	    $(DOCKER) tag $${img}:$(version) $${img}:$(latest) ; \
	    $(DOCKER) push $${img}:$(latest) ; \
	    for m in $${more}; do \
	        $(DOCKER) tag $${img}:$(latest) $${m}:$(latest) ; \
	        $(DOCKER) push $${m}:$(latest) ; \
	    done ; \
	fi

# I keep getting this wrong, so make it work either way.
build: image

image:
	img=$$(echo $(image) | cut -d ',' -f 1) && \
	more=$$(echo $(image) | cut -d ',' -f 2- | tr ',' ' ') && \
	$(DOCKER) build ${platform} --build-arg input=$(input) \
          --build-arg image=$${img} --build-arg tag=$(tag) \
          -t $${img}:$(version) . && \
	for m in $${more}; do \
	    $(DOCKER) tag $${img}:$(version) $${m}:$(version) ; \
	done

retag:
	if [ -z "$(supplementary)" ]; then \
	    echo "supplementary parameter must be set for retag!" ; \
	    exit 1 ; \
	else \
	$(DOCKER) pull ts-dockerhub.lsst.org/sal-sciplat-lab:$(tag) && \
	    outputs=$$(echo $(image) | cut -d ',' -f 1- | tr ',' ' ') && \
	    for o in $${outputs}; do \
	        $(DOCKER) tag ts-dockerhub.lsst.org/sal-sciplat-lab:$(tag) $${o}:$${supplementary} ; \
	        $(DOCKER) push $${o}:$${supplementary} ; \
	    done ; \
	fi
